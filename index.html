<!DOCTYPE html>
<html>
<head>
	<title>Circles</title>
	<script type="text/javascript" src="./raphael.js"></script>
	<script type="text/javascript" src="./easing.js"></script>
	<script type="text/javascript" src="./stampit.js"></script>
  <style type="text/css">
    @font-face {
      font-family: 'HelveticaNeueLTStd-Lt';
      src: url('./helveticaneue/HelveticaNeueLTStd-Lt.otf');
      font-weight: lighter;
      font-style: normal;
    }
  </style>
		
</head>
<body>

<script type="text/javascript" src="./main.js"></script>

<script>

  // shim layer with setTimeout fallback
  (function() {
      var lastTime = 0;
      var vendors = ['ms', 'moz', 'webkit', 'o'];
      for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
          window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
          window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                    || window[vendors[x]+'CancelRequestAnimationFrame'];
      }
  
      if (!window.requestAnimationFrame)
          window.requestAnimationFrame = function(callback, element) {
              var currTime = new Date().getTime();
              var timeToCall = Math.max(0, 16 - (currTime - lastTime));
              var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
                timeToCall);
              lastTime = currTime + timeToCall;
              return id;
          };
  
      if (!window.cancelAnimationFrame)
          window.cancelAnimationFrame = function(id) {
              clearTimeout(id);
          };
  }());
 
  
  var mainPaper = Raphael(0, 0, 1280, 750); 
  var centerVector = {}; 
  centerVector.x = Math.round(mainPaper.width / 2);
  centerVector.y = Math.round(mainPaper.height / 2);
  
  var levelDefinition = {
    "60_80": {
      position: centerVector,    
      args: [mainPaper, 200],
      smartBubbles: [
        {name: '60%', position: 160, args: [mainPaper, 50, 0.6, 0.2, "60%\nBlah blah"]},
      ]
    },   
    "80_100": {
      parent: "60_80",
      position: 340,
      args: [mainPaper, 200],
      smartBubbles: [
        {name: '80%', position: 30, args: [mainPaper, 50, 0.8, 0.2, "80%\nBlah blah"]},
        {name: '98%', position: 160, args: [mainPaper, 50, 1, 0.2, "98%\nVan uw bezoekers kijkt, maar koopt niet!"]},
      ]
    },   
    "40_60": {
      parent: "60_80",
      position: 210,
      args: [mainPaper, 150],
      smartBubbles: [
        {name: '40%', position: 220, args: [mainPaper, 50, 0.7, 0.2, "40%\nBlah blah"]},
      ]
    },   
    "20_40": {
      parent: "40_60",
      position: 165,
      args: [mainPaper, 120],
      smartBubbles: [
        {name: '20%', position: 160, args: [mainPaper, 50, 0.5, 0.2, "20%\nBlah blah"]},
      ]
    }  
  };


  var App = {
    objectStore: [],

    init: function(mainPaper, levelDefinition) {

      // Generate all objects
      var resolveBackgroundParents = {}; 
      for (var i = 0; i < Object.keys(levelDefinition).length; i++) {
        var b = levelDefinition[Object.keys(levelDefinition)[i]];
        
        // BackgroundBubbles
        this.objectStore.push( { 
              bubble: BackgroundBubble.apply(null, b.args),
              parentID: b.parent,
              position: b.position,
              name: Object.keys(levelDefinition)[i] 
            });
       
        // SmartBubbles
        var p_idx = this.objectStore.length -1;
        resolveBackgroundParents[Object.keys(levelDefinition)[i]] = p_idx;

        for (var x = 0; x < b.smartBubbles.length; x++) {
          var s = b.smartBubbles[x];
          this.objectStore.push( { 
                bubble: SmartBubble.apply(null, s.args),
                parentID: p_idx,
                position: s.position,
                name: s.name 
              });
        }
      }

      // Translate parentID string to array index ID
      for (var i = 0; i < this.objectStore.length; i++) {
        if (typeof this.objectStore[i].parentID !== 'number') {
          this.objectStore[i].parentID = 
            resolveBackgroundParents[this.objectStore[i].parentID];
        }
      }
      console.log(resolveBackgroundParents);
      console.log(this.objectStore);
      this.frame(); // This starts the game loop
    },

    frame: function() {
      App.setDelta();
      App.update();
      App.render();
      App.animationFrame = window.requestAnimationFrame(App.frame);
    },

    setDelta: function() {
      App.now = Date.now();
      if ( typeof App.then !== 'undefined' ) {
        App.delta = (App.now - App.then) / 1000; // seconds since last frame
      } else {
        App.delta = 0;
      }
      App.then = App.now;
    },

    update: function() {

      var distance = 100 * App.delta;
      for (var i = 0; i < this.objectStore.length; i++) {
        var obj = this.objectStore[i];
        if ( typeof obj.position === 'object' ) {
          obj.bubble.update(obj.position, distance); 
        } else {
          obj.bubble.update(
              this.objectStore[obj.parentID].bubble.getCircumWorldCoordsByDegrees(obj.position),
              distance
              ); 
        }
      }
    },

    render: function() {
      mainPaper.clear(); // clean our stage
      for (var i = 0; i < this.objectStore.length; i++) {
        var obj = this.objectStore[i];
        obj.bubble.render();
      } 
    }
  
  };

  App.init(mainPaper, levelDefinition);
  
</script>
</body>
</html>
